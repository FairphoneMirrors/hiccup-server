<html>
<head>
  <meta charset="utf-8">
  <META HTTP-EQUIV="refresh" CONTENT="300">
    <link rel="stylesheet" type="text/css" href="/static/crashreports/old_style.css" charset="utf-8" >    
    <script src="/static/crashreports/jquery-latest.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
  </head>
  
  <body>
    <h1> Hiccup Stats </h1>
    <div id="container">
      <div id = "all_fingerprints" class="chart">
      </div>
      <div id = "probable_crashes" class="chart">
      </div >
      <div id = "Crash_Distribution" class="chart">
      </div >
      <div id = "Crash_Distribution_crashes" class="chart">
      </div >
      <div id = "SMPL_chart" class="chart">
      </div >
    </div>
    <script>
    
    console.log("test");
    
    // Load the Visualization API and the corechart package.
    google.charts.load('current', {'packages':['corechart']});
    
    // Set a callback to run when the Google Visualization API is loaded.
    google.charts.setOnLoadCallback(drawChart);
    
    function aggregate_build_fingerprints(data) {
      totals = {}
      data = clear_fake_crashes(data)
      for (var entry in data) {
        key = ""
        if (data[entry].build_fingerprint.includes("a:user")) {
          key = "DDRFIX";
        } else {
          key = "Normal"
        }
        if (!totals[key]) {
          console.log(data[entry].build_fingerprint);
          totals[key] = 0;
        } 
        totals[key] += 1;
      }
      ret = []
      for (var entry in totals) {
        ret.push([entry, totals[entry]])
      }
      return ret;
    } 
    
    function aggregate_uuid(data) {
      data = clear_fake_crashes(data)
      totals = {}
      for (var entry in data) {
        if (!totals[data[entry].uuid]) {
          console.log(data[entry].uuid);
          totals[data[entry].uuid] = 0;
        } 
        totals[data[entry].uuid] += 1;
      }
      ret = []
      for (var entry in totals) {
        ret.push([entry, totals[entry]])
      }
      return ret;
    }
    

    function clear_fake_crashes(data) {
      ret = {}
      for (var entry in data) {
        if (data[entry].boot_reason=="FAKECRASH") {
          continue;
        }
        ret[entry]=data[entry];
      }
      return ret;
    }
    
    function aggregate_SMPL(data) {
      totals = {}
      data = clear_fake_crashes(data)
      for (var entry in data) {
        key = ""
        if (data[entry].power_on_reason.includes("SMPL")) {
          key = "SMPL";
        } else if (data[entry].power_off_reason.includes("SOFT")) {
          key = "Crash";        
        } else {
          continue;
        }
        if (!totals[key]) {
          console.log(data[entry].build_fingerprint);
          totals[key] = 0;
        } 
        totals[key] += 1;
      }
      ret = []
      for (var entry in totals) {
        ret.push([entry, totals[entry]])
      }
      return ret;
    } 
    
    function drawChart() {
      drawChartFromDate("2016-09-09","");
    }
    
    function drawChartFromDate(startDate,endDate) {
      drawChartFingerprints("/hiccup/crashreports/?format=json&start_date="+startDate+"&end_date="+endDate, "All Crashreports", 'all_fingerprints',aggregate_build_fingerprints);
      drawChartFingerprints("/hiccup/crashreports/?format=json&start_date="+startDate+"&end_date="+endDate+"&boot_reason=keyboard+power+on", "Probable Crashes", 'probable_crashes', aggregate_build_fingerprints);
      drawChartFingerprints("/hiccup/crashreports/?format=json&start_date="+startDate+"&end_date="+endDate, "SMPL or Crash", 'SMPL_chart', aggregate_SMPL);
      drawUuidHistogram("/hiccup/crashreports/?format=json&start_date="+startDate+"&end_date="+endDate, "Crash Distribution", 'Crash_Distribution');
      drawUuidHistogram("/hiccup/crashreports/?format=json&start_date="+startDate+"&end_date="+endDate+"&boot_reason=keyboard+power+on", "Crash Distribution (probable Crashes)", 'Crash_Distribution_crashes');
    }
    
    function drawChartFingerprints(url, title, element, aggregate_function) { $.getJSON( url, function( data ) {
      var totals_fingerprint = aggregate_function(data);
      var options = {
        title: title,
        pieHole: 0.4,
      };
      var chart = new google.visualization.PieChart(document.getElementById(element));
      var data = new google.visualization.DataTable();
      data.addColumn('string', 'Build Fingerprint');
      data.addColumn('number', 'Number of Crashreports');
      data.addRows(totals_fingerprint);
      chart.draw(data, options);
    });
    }
  
  function drawUuidHistogram(url, title, element) { $.getJSON( url, function( data ) {
    var totals_fingerprint = aggregate_uuid(data);
    var options = {
      title: title,
      pieHole: 0.4,
    };
    var chart = new google.visualization.Histogram(document.getElementById(element));
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Build Fingerprint');
    data.addColumn('number', 'Number of Crashreports');
    data.addRows(totals_fingerprint);
    chart.draw(data, options);
  });
 }
</script>
</body>
</html>
